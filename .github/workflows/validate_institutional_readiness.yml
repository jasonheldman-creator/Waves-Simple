name: Validate Institutional Readiness

on:
  push:
    branches:
      - main
      - develop
      - 'copilot/**'
    paths:
      - 'app.py'
      - 'validation/validate_institutional_readiness.py'
      - '.github/workflows/validate_institutional_readiness.yml'
  
  pull_request:
    branches:
      - main
      - develop
    paths:
      - 'app.py'
      - 'validation/validate_institutional_readiness.py'
      - '.github/workflows/validate_institutional_readiness.yml'
  
  workflow_dispatch:

jobs:
  validate:
    name: Institutional Readiness Validation
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Run validation script
        id: validate
        run: |
          echo "Running Institutional Readiness validation..."
          python3 validation/validate_institutional_readiness.py
          exit_code=$?
          echo "exit_code=$exit_code" >> $GITHUB_OUTPUT
          exit $exit_code
      
      - name: Upload validation results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: validation-results
          path: |
            validation/
          retention-days: 30
      
      - name: Comment validation status on PR
        if: github.event_name == 'pull_request' && always()
        uses: actions/github-script@v7
        with:
          script: |
            const exitCode = '${{ steps.validate.outputs.exit_code }}';
            const status = exitCode === '0' ? '✅ PASSED' : '❌ FAILED';
            const emoji = exitCode === '0' ? '✅' : '❌';
            
            const body = `## ${emoji} Institutional Readiness Validation
            
            **Status**: ${status}
            **Exit Code**: ${exitCode}
            
            The validation script has ${exitCode === '0' ? 'passed all checks' : 'detected issues'}.
            
            ### Validation Scope
            - Tab label consistency
            - Function structure  
            - Tab ordering (first position)
            - Executive language patterns
            - Diagnostics collapse state
            - Threshold constants
            
            ${exitCode === '0' 
              ? '✓ All 6 validation checks passed successfully!' 
              : '⚠️ One or more validation checks failed. Review the workflow logs for details.'}
            
            ---
            
            For detailed results, check the [workflow run](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}).
            `;
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: body
            });
      
      - name: Fail workflow if validation failed
        if: steps.validate.outputs.exit_code != '0'
        run: |
          echo "❌ Validation failed - see logs above for details"
          exit 1
