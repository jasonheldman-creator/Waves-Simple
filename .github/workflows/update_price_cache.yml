name: Update Price Cache

on:
  schedule:
    - cron: "0 2 * * *"
  workflow_dispatch:

permissions:
  contents: write

env:
  MIN_SUCCESS_RATE: "0.90"

jobs:
  update_cache:
    runs-on: ubuntu-latest

    steps:
      - name: Check out repository
        uses: actions/checkout@v3
        with:
          persist-credentials: true

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: Install dependencies
        run: |
          pip install -r requirements.txt

      - name: Build price cache
        env:
          MIN_SUCCESS_RATE: ${{ env.MIN_SUCCESS_RATE }}
        run: |
          echo "=== Building Price Cache ==="
          python build_price_cache.py --force

      - name: Run comprehensive validations
        id: validate
        run: |
          echo "=== Running Comprehensive Validations ==="
          python -c "
          import sys
          import os
          import json
          from datetime import datetime
          
          # Add current directory to path
          sys.path.insert(0, '.')
          
          from helpers.cache_validation import (
              validate_trading_day_freshness,
              validate_required_symbols,
              validate_cache_integrity,
              check_for_changes
          )
          
          CACHE_PATH = 'data/cache/prices_cache.parquet'
          
          print('\n' + '=' * 70)
          print('CACHE VALIDATION PIPELINE')
          print('=' * 70)
          print(f'Cache path: {CACHE_PATH}')
          print(f'Today: {datetime.now().date()}')
          print('')
          
          # Validation 1: Cache integrity
          print('--- Validation 1: Cache Integrity ---')
          integrity_result = validate_cache_integrity(CACHE_PATH)
          if not integrity_result['valid']:
              print(f'✗ FAIL: {integrity_result[\"error\"]}')
              sys.exit(1)
          print(f'  File exists: {integrity_result[\"file_exists\"]}')
          print(f'  File size: {integrity_result[\"file_size_bytes\"]:,} bytes')
          print(f'  Symbol count: {integrity_result[\"symbol_count\"]}')
          print('')
          
          # Validation 2: Required symbols
          print('--- Validation 2: Required Symbols ---')
          symbols_result = validate_required_symbols(CACHE_PATH)
          if not symbols_result['valid']:
              print(f'✗ FAIL: {symbols_result[\"error\"]}')
              sys.exit(1)
          print(f'  Total symbols in cache: {len(symbols_result[\"symbols_in_cache\"])}')
          print(f'  VIX group present: {symbols_result[\"present_vix_group\"]}')
          print(f'  T-bill group present: {symbols_result[\"present_tbill_group\"]}')
          print('')
          
          # Validation 3: Trading-day freshness
          print('--- Validation 3: Trading-Day Freshness ---')
          freshness_result = validate_trading_day_freshness(CACHE_PATH, max_market_feed_gap_days=5)
          
          # Store freshness result for no-change logic
          cache_is_fresh = freshness_result['valid']
          
          if not cache_is_fresh:
              print(f'⚠️  WARNING: {freshness_result[\"error\"]}')
              print(f'  Today: {freshness_result[\"today\"].date()}')
              print(f'  Last trading day: {freshness_result[\"last_trading_day\"].date() if freshness_result[\"last_trading_day\"] else \"N/A\"}')
              print(f'  Cache max date: {freshness_result[\"cache_max_date\"].date() if freshness_result[\"cache_max_date\"] else \"N/A\"}')
              print(f'  Delta days: {freshness_result[\"delta_days\"]}')
              print(f'  Market feed gap: {freshness_result[\"market_feed_gap_days\"]}')
          else:
              print(f'  Cache is fresh: {cache_is_fresh}')
          print('')
          
          # Check for git changes
          print('--- Git Status Check ---')
          import subprocess
          git_status = subprocess.check_output(['git', 'status', '--porcelain'], text=True).strip()
          has_changes = bool(git_status)
          print(f'  Has uncommitted changes: {has_changes}')
          if git_status:
              print(f'  Changed files:')
              for line in git_status.split('\n')[:10]:
                  print(f'    {line}')
          
          # Show git diff stats
          try:
              git_diff = subprocess.check_output(['git', 'diff', '--stat'], text=True).strip()
              if git_diff:
                  print(f'  Git diff stats:')
                  for line in git_diff.split('\n')[:10]:
                      print(f'    {line}')
          except:
              pass
          print('')
          
          # No-change logic
          print('--- No-Change Logic ---')
          print(f'  Cache fresh: {cache_is_fresh}')
          print(f'  Has changes: {has_changes}')
          
          if cache_is_fresh and not has_changes:
              # Fresh + unchanged → SUCCESS (no commit)
              print('✓ PASS: Fresh but unchanged — no commit needed')
              # Set output for next step
              with open(os.environ['GITHUB_OUTPUT'], 'a') as f:
                  f.write('should_commit=false\n')
                  f.write('workflow_status=success\n')
                  f.write('message=Fresh but unchanged — no commit needed\n')
              sys.exit(0)
          elif cache_is_fresh and has_changes:
              # Fresh + changed → SUCCESS (commit)
              print('✓ PASS: Fresh and changed — will commit updates')
              with open(os.environ['GITHUB_OUTPUT'], 'a') as f:
                  f.write('should_commit=true\n')
                  f.write('workflow_status=success\n')
                  f.write('message=Fresh and changed — committing updates\n')
              sys.exit(0)
          elif not cache_is_fresh and not has_changes:
              # Stale + unchanged → FAIL
              print('✗ FAIL: Stale + unchanged')
              with open(os.environ['GITHUB_OUTPUT'], 'a') as f:
                  f.write('should_commit=false\n')
                  f.write('workflow_status=failure\n')
                  f.write('message=Stale + unchanged\n')
              sys.exit(1)
          else:
              # Stale + changed → SUCCESS (commit stale data that was updated)
              print('✓ PASS: Stale but changed — will commit updates')
              with open(os.environ['GITHUB_OUTPUT'], 'a') as f:
                  f.write('should_commit=true\n')
                  f.write('workflow_status=success\n')
                  f.write('message=Stale but changed — committing updates\n')
              sys.exit(0)
          "

      - name: Display metadata
        run: |
          echo "=== Cache Metadata ==="
          if [ -f data/cache/prices_cache_meta.json ]; then
            cat data/cache/prices_cache_meta.json
          else
            echo "No metadata file found"
          fi

      - name: Commit and push updated cache
        # Only commit on main branch for scheduled or manual runs AND if should_commit=true
        if: github.ref == 'refs/heads/main' && (github.event_name == 'schedule' || github.event_name == 'workflow_dispatch') && steps.validate.outputs.should_commit == 'true'
        run: |
          echo "=== Committing Changes ==="
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          
          # Show what we're committing
          echo "Git status before commit:"
          git status
          
          # Add cache files
          git add data/cache/prices_cache.parquet
          git add data/cache/prices_cache_meta.json
          
          # Verify we have changes
          if git diff --staged --quiet; then
            echo "⚠️  No changes to commit (should_commit was true but no diff detected)"
          else
            echo "Committing changes..."
            git commit -m "Update prices cache (auto) - ${{ steps.validate.outputs.message }}"
            git push
            echo "✓ Cache files committed and pushed"
          fi

      - name: Workflow complete
        run: |
          echo "=== Workflow Complete ==="
          echo "Status: ${{ steps.validate.outputs.workflow_status }}"
          echo "Message: ${{ steps.validate.outputs.message }}"
          echo "Should commit: ${{ steps.validate.outputs.should_commit }}"