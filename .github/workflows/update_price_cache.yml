name: Update Price Cache (PRICE_BOOK Freshness Option A1)

on:
  # Schedule: Daily after market close (9 PM ET / 2 AM UTC Tue-Sat)
  # Markets close 4 PM ET Mon-Fri, so 9 PM ET gives 5h buffer
  # 9 PM ET = 2 AM UTC (next day due to timezone)
  schedule:
    - cron: "0 2 * * 2-6"  # 2 AM UTC Tuesday-Saturday (covers Mon-Fri market closes)
  
  # Manual trigger with optional days parameter
  workflow_dispatch:
    inputs:
      days:
        description: 'Days of historical data to fetch (default: 365)'
        required: false
        default: '365'
        type: string

permissions:
  contents: write

jobs:
  update-price-cache:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          if [ -f requirements.txt ]; then pip install -r requirements.txt; fi
      
      - name: Determine days parameter
        id: params
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            DAYS="${{ github.event.inputs.days }}"
            echo "days=${DAYS:-365}" >> $GITHUB_OUTPUT
          else
            # Default for scheduled runs: 365 days
            echo "days=365" >> $GITHUB_OUTPUT
          fi
      
      - name: Run price cache builder
        id: build_cache
        run: |
          set -e  # Fail on any error
          
          echo "Building price cache with ${{ steps.params.outputs.days }} days of data..."
          
          # Convert days to years using ceiling division
          # Formula: ceil(days/365) = (days + 365 - 1) / 365
          # E.g., 1-365 days -> 1 year, 366-730 days -> 2 years, etc.
          YEARS=$(( (${{ steps.params.outputs.days }} + 365 - 1) / 365 ))
          echo "Fetching $YEARS year(s) of data (covers ${{ steps.params.outputs.days }} days)"
          
          # Run build_price_cache.py (the existing script that creates the parquet file)
          python build_price_cache.py --force --years $YEARS
          
          # Verify the cache file was created
          if [ ! -f "data/cache/prices_cache.parquet" ]; then
            echo "ERROR: Cache file was not created at data/cache/prices_cache.parquet"
            exit 1
          fi
          
          echo "âœ“ Price cache built successfully"
      
      - name: Extract cache statistics
        id: stats
        run: |
          python extract_cache_stats.py "data/cache/prices_cache.parquet" "$GITHUB_OUTPUT"
      
      - name: Check for changes
        id: check_changes
        run: |
          if git diff --quiet data/cache/prices_cache.parquet; then
            echo "changed=false" >> $GITHUB_OUTPUT
          else
            echo "changed=true" >> $GITHUB_OUTPUT
          fi
      
      - name: Commit and push changes
        if: steps.check_changes.outputs.changed == 'true'
        run: |
          git config user.name "waves-bot"
          git config user.email "actions@github.com"
          git add data/cache/prices_cache.parquet
          
          # Also commit failed_tickers.csv if it exists and was updated
          if [ -f data/cache/failed_tickers.csv ]; then
            git add data/cache/failed_tickers.csv
          fi
          
          git commit -m "Update price cache - ${{ steps.stats.outputs.last_date }} [auto]" || echo "No changes to commit"
          git push
      
      - name: Workflow Summary
        if: always()
        run: |
          echo "## ðŸ“Š Price Cache Update Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ steps.build_cache.outcome }}" = "success" ]; then
            echo "âœ… **Status:** Success" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### Cache Statistics" >> $GITHUB_STEP_SUMMARY
            echo "- **Last Price Date:** ${{ steps.stats.outputs.last_date }}" >> $GITHUB_STEP_SUMMARY
            echo "- **Date Range:** ${{ steps.stats.outputs.first_date }} to ${{ steps.stats.outputs.last_date }}" >> $GITHUB_STEP_SUMMARY
            echo "- **Dimensions:** ${{ steps.stats.outputs.num_rows }} rows Ã— ${{ steps.stats.outputs.num_cols }} columns" >> $GITHUB_STEP_SUMMARY
            echo "- **Tickers Count:** ${{ steps.stats.outputs.num_cols }}" >> $GITHUB_STEP_SUMMARY
            echo "- **File Size:** ${{ steps.stats.outputs.file_size_mb }} MB" >> $GITHUB_STEP_SUMMARY
            echo "- **Data Age:** ${{ steps.stats.outputs.age_days }} days" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            
            if [ "${{ steps.check_changes.outputs.changed }}" = "true" ]; then
              echo "âœ… **Cache Updated:** Changes committed and pushed" >> $GITHUB_STEP_SUMMARY
            else
              echo "â„¹ï¸ **Cache Status:** No changes detected" >> $GITHUB_STEP_SUMMARY
            fi
          else
            echo "âŒ **Status:** Failed" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "The price cache update failed. Please check the logs above for details." >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**Common issues:**" >> $GITHUB_STEP_SUMMARY
            echo "- Network connectivity to Yahoo Finance" >> $GITHUB_STEP_SUMMARY
            echo "- Missing or invalid ticker symbols" >> $GITHUB_STEP_SUMMARY
            echo "- Insufficient API rate limits" >> $GITHUB_STEP_SUMMARY
          fi
