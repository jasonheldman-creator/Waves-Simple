name: Update Price Cache

on:
  schedule:
    - cron: "0 2 * * *"

env:
  REQUIRED_TICKERS: "SPY, AAPL"
  OPTIONAL_TICKERS: "MSFT, GOOGL"
  MIN_SUCCESS_RATE: "0.95"

jobs:
  update_cache:
    runs-on: ubuntu-latest

    steps:
      - name: Check out repository
        uses: actions/checkout@v3

      - name: Fetch prices for required tickers
        run: |
          IFS=',' read -r -a tickers <<< "$REQUIRED_TICKERS"
          missing_tickers=""
          for ticker in "${tickers[@]}"; do
            if ! ./fetch_price.sh "$ticker"; then
              missing_tickers+="$ticker "
            fi
          done
          if [ -n "$missing_tickers" ]; then
            echo "::error::Failed to fetch required tickers: $missing_tickers"
            exit 1
          fi

      - name: Fetch prices for optional tickers
        run: |
          IFS=',' read -r -a tickers <<< "$OPTIONAL_TICKERS"
          failed_tickers=""
          for ticker in "${tickers[@]}"; do
            if ! ./fetch_price.sh "$ticker"; then
              failed_tickers+="$ticker "
            fi
          done
          if [ -n "$failed_tickers" ]; then
            echo "::warning::Failed to fetch optional tickers: $failed_tickers"
          fi

      - name: Finalize Workflow
        run: |
          echo "All required tickers updated successfully."