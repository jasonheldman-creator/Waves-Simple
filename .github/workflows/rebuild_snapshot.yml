name: Rebuild Live Snapshot

on:
  workflow_dispatch:
  push:
    branches:
      - main

concurrency:
  group: rebuild-live-snapshot
  cancel-in-progress: false

jobs:
  rebuild:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          if [ -f requirements.txt ]; then
            pip install -r requirements.txt
          else
            pip install pandas numpy yfinance
          fi

      - name: Verify required inputs
        run: |
          echo "Checking required files..."
          test -f data/wave_weights.csv || (echo "❌ data/wave_weights.csv missing" && exit 1)
          echo "✅ wave_weights.csv found"

      - name: Generate live snapshot
        run: |
          python scripts/generate_live_snapshot_csv.py

      - name: Verify output snapshot
        run: |
          test -f data/live_snapshot.csv || (echo "❌ live_snapshot.csv not created" && exit 1)
          echo "✅ live_snapshot.csv created"
          wc -l data/live_snapshot.csv

      - name: Commit snapshot
        run: |
          git config user.name "github-actions"
          git config user.email "actions@github.com"

          # Ensure branch is fully up to date before committing
          git pull --rebase origin main

          git add data/live_snapshot.csv
          git diff --cached --quiet && echo "No snapshot changes to commit" && exit 0

          git commit -m "Rebuild live snapshot"
          git push origin main