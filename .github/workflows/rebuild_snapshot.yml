name: Rebuild Snapshot

on:
  workflow_dispatch:

permissions:
  contents: write

concurrency:
  group: rebuild-snapshot
  cancel-in-progress: true

jobs:
  rebuild:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: ${{ github.head_ref || github.ref_name }}

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install deps
        run: |
          python -m pip install --upgrade pip
          if [ -f requirements.txt ]; then pip install -r requirements.txt; fi

      - name: Run snapshot (Option A)
        run: |
          python scripts/rebuild_snapshot.py

      # IMPORTANT:
      # PR runs should NOT try to commit/push (they are checks only).
      # For workflow_dispatch: ALWAYS commit (even small metadata changes)
      - name: Commit snapshot if changed
        if: github.event_name == 'workflow_dispatch'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          # Add files if they exist; never fail if optional paths are missing
          git add -A data || true
          if [ -d output ]; then git add -A output || true; fi

          if git diff --cached --quiet; then
            echo "⚠ Manual run completed but no changes detected."
            echo "This can happen if the snapshot was just updated by another workflow."
            exit 0
          fi

          # Extract metadata for logging
          echo ""
          echo "========================================================================"
          echo "SNAPSHOT METADATA LOGGING"
          echo "========================================================================"
          
          # Log snapshot date and SPY calendar info
          if [ -f data/live_snapshot.csv ]; then
            echo "Live Snapshot Date:"
            python3 << 'EOF'
import pandas as pd
try:
    df = pd.read_csv('data/live_snapshot.csv')
    if 'Date' in df.columns and not df.empty:
        print(f"  Snapshot Date: {df['Date'].iloc[0]}")
    else:
        print("  Snapshot Date: N/A (empty or missing Date column)")
except Exception as e:
    print(f"  Error reading snapshot: {e}")
EOF
          fi
          
          if [ -f data/cache/prices_cache_meta.json ]; then
            echo ""
            echo "SPY Trading Calendar (from prices_cache_meta.json):"
            python3 << 'EOF'
import json
try:
    with open('data/cache/prices_cache_meta.json', 'r') as f:
        meta = json.load(f)
    print(f"  spy_max_date: {meta.get('spy_max_date', 'N/A')}")
    print(f"  max_price_date: {meta.get('max_price_date', 'N/A')}")
except Exception as e:
    print(f"  Error reading cache metadata: {e}")
EOF
          fi

          echo ""
          echo "Committing changes..."
          git commit -m "Rebuild live snapshot (manual run)"
          
          COMMIT_SHA=$(git rev-parse HEAD)
          echo "  Commit SHA: $COMMIT_SHA"

          # Authenticated remote + explicit branch push (avoids detached HEAD failures)
          git remote set-url origin "https://x-access-token:${GITHUB_TOKEN}@github.com/${{ github.repository }}.git"
          BRANCH="${GITHUB_REF_NAME}"
          git push origin "HEAD:${BRANCH}"
          
          echo ""
          echo "✓ Snapshot files committed and pushed successfully"
          echo "  Last commit SHA: $COMMIT_SHA"
          echo "========================================================================"